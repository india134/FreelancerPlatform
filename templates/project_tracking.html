{# templates/project_tracking.html #}
{% extends "base.html" %}
{% block title %}Project Tracking: {{ project.title }}{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row">

    {# ───────── Sidebar ───────── #}
    <aside class="col-md-3 mb-4">

      {# Upcoming Meetings #}
      <div class="card mb-3">
        <div class="card-header">Upcoming Meetings</div>
        <ul class="list-group list-group-flush">
          {% if project.meetings %}
            {% for m in project.meetings %}
              <li class="list-group-item d-flex justify-content-between align-items-start">
                <div>
                  <strong>{{ m.when.strftime('%Y-%m-%d %H:%M') }}</strong><br>
                  <small class="text-muted">{{ m.agenda }}</small>
                </div>
                <div class="d-flex align-items-center">
                  {# Join button uses the client’s stored meeting_link #}
                  <a href="{{ project.client.meeting_link }}"
                     target="_blank"
                     class="btn btn-sm btn-outline-primary me-2">
                    Join
                  </a>
                  <form method="POST" action="{{ url_for('cancel_meeting', meeting_id=m.id) }}">
                    {{ csrf_form.hidden_tag() }}
                    <button class="btn btn-sm btn-outline-danger">&times;</button>
                  </form>
                </div>
              </li>
            {% endfor %}
          {% else %}
            <li class="list-group-item text-muted">No meetings scheduled</li>
          {% endif %}
        </ul>
      </div>

      {# Schedule a Meeting #}
      <div class="card mb-3">
        <div class="card-header">Schedule a Meeting</div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('schedule_meeting', project_id=project.id) }}">
            {{ csrf_form.hidden_tag() }}
            <label class="form-label small">When</label>
            <input type="datetime-local" name="when"
                   class="form-control form-control-sm mb-2" required>
            <label class="form-label small">Agenda</label>
            <input type="text" name="agenda"
                   class="form-control form-control-sm mb-2" required>
            <button class="btn btn-sm btn-primary w-100">Schedule</button>
          </form>
        </div>
      </div>

      {# Invoices #}
      <div class="card mb-3">
        <div class="card-header">Invoices</div>
        <ul class="list-group list-group-flush">
          {% if invoices %}
            {% for inv in invoices %}
              <li class="list-group-item d-flex justify-content-between">
                {{ inv.created_at.strftime('%Y-%m-%d') }}
                <a href="{{ url_for('download_invoice', invoice_id=inv.id) }}" target="_blank">PDF</a>
              </li>
            {% endfor %}
          {% else %}
            <li class="list-group-item text-muted">No invoices</li>
          {% endif %}
        </ul>
      </div>

    </aside>


    {# ───────── Main Tracker + Revisions ───────── #}
    <main class="col-md-9">

      <h2 class="mb-4">Project Tracking: {{ project.title }}</h2>

      {# — Iterate over each PricingStage — #}
      {% for stage in stages %}
        <div class="card mb-4 p-3">
          <h5>Stage {{ stage.stage_number }}: {{ stage.tech_details or 'No details provided' }}</h5>

          {# ── Phase buttons & notes ── #}
          <div class="row g-3 mb-3">
            {% for ph in phases %}
              <div class="col-md-3">
                <form method="POST" action="{{ url_for('update_phase_status') }}">
                  {{ csrf_form.hidden_tag() }}
                  <input type="hidden" name="stage_id" value="{{ stage.id }}">
                  <input type="hidden" name="phase"    value="{{ ph }}">
                  <button class="btn w-100 mb-2
                    {% if statuses[stage.id][ph] == 'Complete' %}
                      btn-success
                    {% else %}
                      btn-outline-secondary
                    {% endif %} text-start">
                    {{ ph }} – {{ statuses[stage.id][ph] }}
                  </button>
                </form>

                <div class="border rounded p-2 mb-2" style="max-height:150px; overflow:auto;">
                  {% for c in comments[stage.id][ph] %}
                    <div class="d-flex justify-content-between mb-2">
                      <div>
                        <small>{{ c.content }}</small><br>
                        <small class="text-muted">{{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                      </div>
                      <form method="POST" action="{{ url_for('delete_comment', comment_id=c.id) }}">
                        {{ csrf_form.hidden_tag() }}
                        <button class="btn btn-sm btn-outline-danger">✖</button>
                      </form>
                    </div>
                  {% endfor %}
                </div>

                <form method="POST" action="{{ url_for('add_phase_comment') }}">
                  {{ csrf_form.hidden_tag() }}
                  <input type="hidden" name="stage_id" value="{{ stage.id }}">
                  <input type="hidden" name="phase"    value="{{ ph }}">
                  <div class="input-group">
                    <input type="text" name="comment"
                           class="form-control form-control-sm"
                           placeholder="Add a note…" required>
                    <button class="btn btn-sm btn-outline-primary">Save</button>
                  </div>
                </form>
              </div>
            {% endfor %}

            {# ── Payment column ── #}
            <div class="col-md-3">
              <form method="POST" action="{{ url_for('update_stage_payment') }}">
                {{ csrf_form.hidden_tag() }}
                <input type="hidden" name="stage_id" value="{{ stage.id }}">
                <button class="btn w-100 mb-2
                  {% if stage.payment_status == 'paid' %}
                    btn-success
                  {% else %}
                    btn-outline-secondary
                  {% endif %}">
                  Payment – {{ stage.payment_status.capitalize() }}
                </button>
              </form>
            </div>
          </div>

          {# ───────── Task List ───────── #}
          <div class="mt-3">
            <h6 class="mb-2">Tasks for this Stage</h6>
            <table class="table table-sm table-striped align-middle">
              <thead class="table-light">
                <tr>
                  <th style="width:35%;">Task Description</th>
                  <th style="width:15%;">Start Date</th>
                  <th style="width:15%;">End Date</th>
                  <th style="width:25%;">Remarks</th>
                  <th style="width:5%;">Done</th>
                  <th style="width:5%;"></th>
                </tr>
              </thead>
              <tbody id="tasks-stage-{{ stage.id }}">
                {% for task in stage.tasks %}
                  <tr id="task-{{ task.id }}">
                    <td>{{ task.description }}</td>
                    <td>{{ task.start_date and task.start_date.strftime('%Y-%m-%d') or '' }}</td>
                    <td>{{ task.end_date and task.end_date.strftime('%Y-%m-%d') or '' }}</td>
                    <td>{{ task.remarks or '' }}</td>
                    <td class="text-center">
                      <input
                        type="checkbox"
                        class="form-check-input task-toggle"
                        data-task-id="{{ task.id }}"
                        {% if task.is_done %}checked{% endif %}
                        {% if project.client.freelancer_id != session.get('user_id') %}disabled{% endif %}
                      >
                    </td>
                    <td class="text-center">
                      {% if project.client.freelancer_id == session.get('user_id') %}
                        <button
                          class="btn btn-sm btn-outline-danger task-delete"
                          data-task-id="{{ task.id }}"
                          title="Delete Task"
                        >&times;</button>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}

<tbody id="tasks-stage-{{ stage.id }}">
          {# … existing task rows … #}

            {% if project.client.freelancer_id == session.get('user_id') %}
    <tr id="add-task-row-{{ stage.id }}">
      <td colspan="6">
        <form class="row g-2 align-items-center" data-stage-id="{{ stage.id }}">
          <!-- 1) Hidden fields must be INSIDE this <form> -->
          <input type="hidden" name="stage_id"    value="{{ stage.id }}">
          <input type="hidden" name="project_id"  value="{{ project.id }}">

          <!-- 2) Visible inputs -->
          <div class="col-auto" style="width:35%;">
            <input
              type="text"
              name="description"
              class="form-control form-control-sm"
              placeholder="New task description…"
              required
            >
          </div>
          <div class="col-auto" style="width:15%;">
            <input
              type="date"
              name="start_date"
              class="form-control form-control-sm"
            >
          </div>
          <div class="col-auto" style="width:15%;">
            <input
              type="date"
              name="end_date"
              class="form-control form-control-sm"
            >
          </div>
          <div class="col-auto" style="width:25%;">
            <input
              type="text"
              name="remarks"
              class="form-control form-control-sm"
              placeholder="Remarks…"
            >
          </div>
          <div class="col-auto" style="width:5%; text-align:center;">
            <!-- placeholder cell for the “Done” column -->
          </div>
          <div class="col-auto" style="width:5%; text-align:center;">
            <button type="submit" class="btn btn-sm btn-primary">+ Add</button>
          </div>
        </form>
      </td>
    </tr>
  {% endif %}
</tbody>

              </tbody>
            </table>
          </div>
        </div>
      {% endfor %}


      {# ─── Request a Revision ─── #}
      <div class="card mb-4">
        <div class="card-header"><h5>Request a Revision</h5></div>
        <div class="card-body">
          <form
            method="POST"
            action="{{ url_for('revision_request', project_id=project.id) }}"
          >
            {{ csrf_form.hidden_tag() }}
            <label class="form-label small">Select Meeting</label>
            <select name="meeting_id" class="form-select form-select-sm mb-2">
              <option value="">None</option>
              {% for m in project.meetings %}
                <option value="{{ m.id }}">
                  {{ m.when.strftime('%Y-%m-%d %H:%M') }}
                </option>
              {% endfor %}
            </select>

            <div class="mb-2">
              <label class="form-label small">Notes</label>
              <textarea name="notes" class="form-control form-control-sm" required></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label small">Cost</label>
              <input
                type="number"
                step="0.01"
                name="cost"
                class="form-control form-control-sm"
                value="0.00"
              >
            </div>

            <button class="btn btn-primary btn-sm">Submit</button>
          </form>
        </div>
      </div>


      {# ─── All Revisions List ─── #}
      <div class="card mb-4">
        <div class="card-header"><h5>All Revisions</h5></div>
        <ul class="list-group list-group-flush">
          {% if revisions %}
            {% for rev in revisions %}
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong>#{{ loop.index }}:</strong> {{ rev.notes }}<br>
                  <small class="text-muted">
                    {{ rev.created_at.strftime('%Y-%m-%d %H:%M') }}
                    {% if rev.cost %}
                      — {{ project.currency }}{{ '%.2f'|format(rev.cost) }}
                    {% endif %}
                  </small>
                </div>

                <div class="d-flex align-items-center">
                  <form method="POST" action="{{ url_for('toggle_revision', rev_id=rev.id) }}">
                    {{ csrf_form.hidden_tag() }}
                    <button class="btn btn-sm
                      {% if rev.is_paid %}btn-success{% else %}btn-outline-warning{% endif %} me-2">
                      {% if rev.is_paid %}✅ Completed{% else %}⌛ Pending{% endif %}
                    </button>
                  </form>
                  {# Delete (X) button #}
                  <form method="POST"
                        action="{{ url_for('delete_revision',
                                            project_id=project.id,
                                            rev_id=rev.id) }}">
                    {{ csrf_form.hidden_tag() }}
                    <button type="submit"
                            class="btn-close"
                            aria-label="Delete revision">
                    </button>
                  </form>
                </div>
              </li>
            {% endfor %}
          {% else %}
            <li class="list-group-item text-muted">No revisions yet</li>
          {% endif %}
        </ul>
      </div>

    </main>
  </div>
</div>

<!-- ───────── JavaScript for Task List Interactivity ───────── -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  //////////////////////////////
  // 1) Handle “Add Task” forms //
  //////////////////////////////
  document.querySelectorAll('form[data-stage-id]').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      // We pass the entire form’s fields (including hidden stage_id/project_id)
      const formData = new FormData(form);

      fetch('/tasks/create', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': '{{ csrf_form.csrf_token._value() }}'
        },
        body: formData
      })
      .then(res => {
        if (!res.ok) {
          // Attempt to parse JSON error message:
          return res.json().then(err => Promise.reject(err));
        }
        return res.json();
      })
      .then(json => {
        // json contains: { id, description, start_date, end_date, remarks }
        const stageId = form.getAttribute('data-stage-id');
        const tbody   = document.getElementById(`tasks-stage-${stageId}`);

        // Build a new <tr> for the newly‐created task:
        const newRow = document.createElement('tr');
        newRow.id = `task-${json.id}`;
        newRow.innerHTML = `
          <td>${json.description}</td>
          <td>${json.start_date || ''}</td>
          <td>${json.end_date   || ''}</td>
          <td>${json.remarks    || ''}</td>
          <td class="text-center">
            <input
              type="checkbox"
              class="form-check-input task-toggle"
              data-task-id="${json.id}"
            >
          </td>
          <td class="text-center">
            <button
              class="btn btn-sm btn-outline-danger task-delete"
              data-task-id="${json.id}"
            >&times;</button>
          </td>`;

        // Try to insert the new row right above the “Add Task” row. If that fails,
        // just append to the end of <tbody> to avoid an “insertBefore” exception.
        const addRow = document.getElementById(`add-task-row-${stageId}`);
        if (addRow && tbody.contains(addRow)) {
          tbody.insertBefore(newRow, addRow);
        } else {
          tbody.appendChild(newRow);
        }

        // Clear the form’s inputs for the next new task:
        form.querySelector('[name="description"]').value = '';
        form.querySelector('[name="start_date"]').value   = '';
        form.querySelector('[name="end_date"]').value     = '';
        form.querySelector('[name="remarks"]').value      = '';
      })
      .catch(err => {
        console.error('Add Task error:', err);
        alert(err.error || 'Failed to add task');
      });
    });
  });

  /////////////////////////////////
  // 2) Handle “Toggle Done” click //
  /////////////////////////////////
  document.body.addEventListener('change', function(e) {
    if (e.target.matches('.task-toggle')) {
      const taskId = e.target.getAttribute('data-task-id');
      fetch(`/tasks/${taskId}/toggle`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': '{{ csrf_form.csrf_token._value() }}'
        }
      })
      .then(res => {
        if (!res.ok) {
          return res.json().then(err => Promise.reject(err));
        }
        return res.json();
      })
      .then(json => {
        // After toggling, server returns { id: <task_id>, is_done: <true/false> }
        const row = document.getElementById(`task-${json.id}`);
        if (json.is_done) {
          row.classList.add('text-decoration-line-through');
        } else {
          row.classList.remove('text-decoration-line-through');
        }
      })
      .catch(err => {
        console.error('Toggle Done error:', err);
        alert(err.error || 'Failed to toggle task status');
      });
    }
  });

  //////////////////////////////////
  // 3) Handle “Delete Task” click //
  //////////////////////////////////
  document.body.addEventListener('click', function(e) {
    if (e.target.matches('.task-delete')) {
      const taskId = e.target.getAttribute('data-task-id');
      fetch(`/tasks/${taskId}/delete`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': '{{ csrf_form.csrf_token._value() }}'
        }
      })
      .then(res => {
        if (!res.ok) {
          return res.json().then(err => Promise.reject(err));
        }
        return res.json();
      })
      .then(json => {
        // If deletion succeeded, remove the <tr> from the DOM:
        const row = document.getElementById(`task-${taskId}`);
        if (row) row.remove();
      })
      .catch(err => {
        console.error('Delete Task error:', err);
        alert(err.error || 'Failed to delete task');
      });
    }
  });
});
</script>

{% endblock %}
